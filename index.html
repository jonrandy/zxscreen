<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>ZXScreen - ZX Spectrum Screen Simulator</title>
</head>
<body>
  <div id="zxs"></div>

  <script src="index.js" type="module"></script>

  <script>


    function dump() {
      for( let pp=0; pp<6912; pp++) {
        zx.poke(16384+pp, (~~(Math.random()*256)))
      }
    }

    document.onclick = dump

    function load(fname = 'test1') {
      let byte, ci, cp, cb, cf
      let oReq = new XMLHttpRequest();
      oReq.open("GET", `/${fname}.scr`, true);
      oReq.responseType = "arraybuffer";

      oReq.onload = function (oEvent) {
        let arrayBuffer = oReq.response;
        if (arrayBuffer) {
          let byteArray = new Uint8Array(arrayBuffer);
          zx.poke$(16384, byteArray);

          console.log(JSON.stringify(RLECompress(byteArray)))

        }
      }

      oReq.send(null);

    }

    function RLECompress(arr) {
      let vals = [], lengths = []
      arr.forEach((v,i)=>{
        if (i) {
          if (v==vals[vals.length-1]) {
            lengths[lengths.length-1]++
          } else {
            vals.push(v)
            lengths.push(1)
          }
        } else {
          vals.push(v)
          lengths[0] = 1
        }
      })
      return [vals, lengths]
    }



  </script>
</body>
</html>