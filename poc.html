<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>ZXBox</title>
  <style>
      #scrs {
      --pixel-size:2px;
}
    .scr * {
      box-sizing:border-box;
    }
    .scr {
      --pixel-size:2px;
      font-size:0;
      width: calc(var(--pixel-size) * 8*32);
    }
    .char {
      width:calc(var(--pixel-size) * 8);
      height: calc(var(--pixel-size) * 8); 
      display:inline-block;
    }
    .char u, .char s {
      height: var(--pixel-size); 
      width: var(--pixel-size); 
      display:inline-block;
    }
    .char s {
      border-left:  var(--pixel-size) solid;
      width:  var(--pixel-size) ;
    }
    
    .p0 {
      background:#000;
    }
    .p1 {
      background:#0000c0;
    }
    .p2 {
      background:#c00000;
    }
    .p3 {
      background:#c000c0;
    }
    .p4 {
      background:#00c000;
    }
    .p5 {
      background:#00c0c0;
    }
    .p6 { 
      background:#c0c000;
    }
    .p7 { 
      background:#c0c0c0;
    }
    .b.p1 {
      background:#0000ff;
    }
    .b.p2 {
      background:#ff0000;
    }
    .b.p3 {
      background:#ff00ff;
    }
    .b.p4 {
      background:#00ff00;
    }
    .b.p5 {
      background:#00ffff;
    }
    .b.p6 { 
      background:#ffff00;
    }
    .b.p7 { 
      background:#ffffff;
    }
    
    .i0 {
      color:#000;
    }
    .i1 {
      color:#0000c0;
    }
    .i2 {
      color:#c00000;
    }
    .i3 {
      color:#c000c0;
    }
    .i4 {
      color:#00c000;
    }
    .i5 {
      color:#00c0c0;
    }
    .i6 { 
      color:#c0c000;
    }
    .i7 { 
      color:#c0c0c0;
    }
    .b.i1 {
      color:#0000ff;
    }
    .b.i2 {
      color:#ff0000;
    }
    .b.i3 {
      color:#ff00ff;
    }
    .b.i4 {
      color:#00ff00;
    }
    .b.i5 {
      color:#00ffff;
    }
    .b.i6 { 
      color:#ffff00;
    }
    .b.i7 { 
      color:#ffffff;
    }
  </style>
</head>
<body>
  <div id="scr" class="zxb_scr">
  </div>

  <script src="index.js" type="module"></script>
  
  <script>

    // Color index to RGB
    // f = i=>((i & 4) >> 1 | (i & 2) << 1  | i & 1).toString(2).padStart(3,0).replace(/0|1/g, m=>['00','ff'][+m])

    const byteToHTML = byte => byte.toString(2).padStart(8,0).replace(/0|1/g, m=>['<u></u>','<s></s>'][+m])

    let scr = document.getElementById('scr')

    function drw() {
      let h = '', p, i
      for (let k=0; k<32*24; k++) {
        p = ~~(Math.random()*8)
        i = ~~(Math.random()*8)
        b = (Math.random() > .5) ? 'b' : ''
        h += `<div class="char i${i} p${p} ${b}">`
        for (let j=0; j<8; j++) {
          h += '<b>' + byteToHTML(0) + '</b>'
        }
        h += `</div>`
      }
      scr.innerHTML = h
    }

    drw()

    let bytes = [...document.getElementsByTagName('b')]
    let chars = [...document.getElementsByClassName('char')]

    let byte

    function dump() {
      for( let pp=0; pp<6144; pp++) {
        byte = (~~(Math.random()*256))
        bytes[zxAddrToByteElOffset(pp+16384)].innerHTML = byteToHTML(byte)

      }
    }

    function zxAddrToByteElOffset(addr) {
      let
        relAddr = addr ^ 16384,
        [charX, zxY] = [relAddr & 31, relAddr >> 5],
        pixY = ( zxY & 192 ) | ((zxY & 56) >> 3) | ((zxY & 7) << 3),
        charY = pixY >> 3
        return (charY << 8) | charX << 3 | (pixY & 7)
    }

    function attrToIPBF(attr) {
      return [
        attr & 7, // ink
        attr >> 3 & 7, // paper
        attr & 64, // bright
        attr & 128 // flash
      ]
    }
    
    document.onclick = dump

    function load(fname = 'test1') {
      let byte, ci, cp, cb, cf
      let oReq = new XMLHttpRequest();
      oReq.open("GET", `/${fname}.scr`, true);
      oReq.responseType = "arraybuffer";

      oReq.onload = function (oEvent) {
        let arrayBuffer = oReq.response;
        if (arrayBuffer) {
          let byteArray = new Uint8Array(arrayBuffer);
          for (var i = 0; i < byteArray.byteLength; i++) {
            if (i<6144) {
              bytes[zxAddrToByteElOffset(i+16384)].innerHTML = byteToHTML(byteArray[i])
            } else {
              [ci, cp, cb, cf] = attrToIPBF(byteArray[i])
              chars[i-6144].className = `char i${ci} p${cp} ${cb?'b':''} ${cf?'f':''}`
            }
          }
        }
      };

      oReq.send(null);

    }


    dump()


  
  </script>
</body>
</html>